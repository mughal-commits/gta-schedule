<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTA North Schedule Manager</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #ffffff;
            --surface-color: #f8fafc;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --text-color: #f1f5f9;
            --border-color: #334155;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            font-weight: 700;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #475569;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .theme-toggle {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-color);
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        .table th {
            background: var(--bg-color);
            font-weight: 600;
            color: var(--text-color);
        }

        .table tr:hover {
            background: var(--bg-color);
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .team-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .team-title {
            font-weight: 600;
            color: var(--primary-color);
        }

        .associate-schedule {
            margin-bottom: 10px;
            padding: 8px;
            background: var(--bg-color);
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .associate-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .shift-times {
            font-size: 12px;
            color: var(--secondary-color);
            font-family: monospace;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
        }

        .close-btn:hover {
            color: var(--text-color);
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--secondary-color);
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .vacation-request {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            background: var(--bg-color);
        }

        .vacation-request.pending {
            border-left: 4px solid var(--warning-color);
        }

        .vacation-request.approved {
            border-left: 4px solid var(--success-color);
        }

        .vacation-request.rejected {
            border-left: 4px solid var(--danger-color);
        }

        .vacation-dates {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .vacation-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .print-schedule {
            background: white;
            color: black;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-schedule, .print-schedule * {
                visibility: visible;
            }
            .print-schedule {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header-controls {
                justify-content: center;
            }
            
            .schedule-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GTA North Schedule Manager</h1>
            <div class="header-controls">
                <button class="btn theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
                <button class="btn btn-warning" onclick="showVacationModal()">Request Vacation</button>
                <button class="btn btn-secondary" onclick="showAdminModal()">Admin Panel</button>
                <button class="btn btn-primary" onclick="showEditModal()">Edit Schedules</button>
                <button class="btn btn-primary" onclick="showPrintModal()">Print Schedule</button>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="card">
            <div class="card-title">Upload Schedule File</div>
            <div class="form-group">
                <label class="form-label">Select Excel file containing schedule data:</label>
                <input type="file" class="form-control" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                <small style="color: var(--secondary-color); margin-top: 5px; display: block;">
                    Supported formats: Excel (.xlsx, .xls) and CSV files. Click "File Format Help" for template.
                </small>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                <button class="btn btn-primary" onclick="generateSampleData()">Load Sample Data</button>
                <button class="btn btn-success" onclick="downloadExcelTemplate()">Download Excel Template</button>
                <button class="btn btn-secondary" onclick="showFileFormatHelp()">File Format Help</button>
            </div>
        </div>

        <!-- Schedule Display -->
        <div id="scheduleContainer"></div>

        <!-- Total Hours Display -->
        <div id="totalHoursContainer"></div>
    </div>

    <!-- Vacation Request Modal -->
    <div class="modal" id="vacationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Vacation Requests</h2>
                <button class="close-btn" onclick="closeModal('vacationModal')">&times;</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('request-tab', 'request-content')">New Request</button>
                <button class="tab" onclick="switchTab('my-requests-tab', 'my-requests-content')">My Requests</button>
            </div>

            <div class="tab-content active" id="request-content">
                <form onsubmit="submitVacationRequest(event)">
                    <div class="form-group">
                        <label class="form-label">Associate Name:</label>
                        <select class="form-control" id="vacationAssociate" required>
                            <option value="">Select Associate</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date:</label>
                        <input type="date" class="form-control" id="vacationStartDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date:</label>
                        <input type="date" class="form-control" id="vacationEndDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (Optional):</label>
                        <textarea class="form-control" id="vacationNotes" rows="3" placeholder="Additional information about your vacation request..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </form>
            </div>

            <div class="tab-content" id="my-requests-content">
                <div id="myRequestsList"></div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Admin Panel</h2>
                <button class="close-btn" onclick="closeModal('adminModal')">&times;</button>
            </div>
            
            <div id="adminLogin">
                <div class="form-group">
                    <label class="form-label">Admin Password:</label>
                    <input type="password" class="form-control" id="adminPassword" placeholder="Enter admin password">
                </div>
                <button class="btn btn-primary" onclick="adminLogin()">Login</button>
            </div>

            <div id="adminContent" style="display: none;">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('vacation-admin-tab', 'vacation-admin-content')">Vacation Requests</button>
                </div>

                <div class="tab-content active" id="vacation-admin-content">
                    <div class="form-group">
                        <label class="form-label">Filter by Status:</label>
                        <select class="form-control" id="statusFilter" onchange="filterVacationRequests()">
                            <option value="">All Requests</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div id="adminVacationList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Schedules</h2>
                <button class="close-btn" onclick="closeModal('editModal')">&times;</button>
            </div>
            
            <div id="editLogin">
                <div class="form-group">
                    <label class="form-label">Edit Password:</label>
                    <input type="password" class="form-control" id="editPassword" placeholder="Enter edit password">
                </div>
                <button class="btn btn-primary" onclick="editLogin()">Login</button>
            </div>

            <div id="editContent" style="display: none;">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('teams-tab', 'teams-content')">Manage Teams</button>
                    <button class="tab" onclick="switchTab('associates-tab', 'associates-content')">Manage Associates</button>
                </div>

                <div class="tab-content active" id="teams-content">
                    <div class="form-group">
                        <label class="form-label">Add New Team:</label>
                        <input type="text" class="form-control" id="newTeamName" placeholder="Team name (e.g., Team 192)">
                    </div>
                    <button class="btn btn-success" onclick="addTeam()">Add Team</button>
                    
                    <div id="teamsList" style="margin-top: 20px;"></div>
                </div>

                <div class="tab-content" id="associates-content">
                    <div class="form-group">
                        <label class="form-label">Team:</label>
                        <select class="form-control" id="associateTeam">
                            <option value="">Select Team</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Associate Name:</label>
                        <input type="text" class="form-control" id="associateName" placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Code:</label>
                        <input type="text" class="form-control" id="associateCode" placeholder="3-letter code (e.g., ABC)">
                    </div>
                    <button class="btn btn-success" onclick="addAssociate()">Add Associate</button>
                    
                    <div id="associatesList" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Modal -->
    <div class="modal" id="printModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Print Schedule</h2>
                <button class="close-btn" onclick="closeModal('printModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Team:</label>
                <select class="form-control" id="printTeam">
                    <option value="">All Teams</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Month/Year:</label>
                <input type="month" class="form-control" id="printMonth" value="2025-08">
            </div>
            <button class="btn btn-primary" onclick="generatePrintSchedule()">Generate Print View</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let scheduleData = {};
        let vacationRequests = [];
        let isAdminLoggedIn = false;
        let isEditLoggedIn = false;
        
        // Passwords (hardcoded - change these for production)
        const ADMIN_PASSWORD = 'admin123';
        const EDIT_PASSWORD = 'edit456';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromStorage();
            applyTheme();
            
            // Initialize date inputs with today's date
            const today = new Date().toISOString().split('T')[0];
            const startDateInput = document.getElementById('vacationStartDate');
            const endDateInput = document.getElementById('vacationEndDate');
            
            if (startDateInput) startDateInput.min = today;
            if (endDateInput) endDateInput.min = today;
        });

        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // Data Storage Management
        function saveDataToStorage() {
            const data = {
                scheduleData: scheduleData,
                vacationRequests: vacationRequests
            };
            localStorage.setItem('gta_north_schedule_data', JSON.stringify(data));
        }

        function loadDataFromStorage() {
            const stored = localStorage.getItem('gta_north_schedule_data');
            if (stored) {
                const data = JSON.parse(stored);
                scheduleData = data.scheduleData || {};
                vacationRequests = data.vacationRequests || [];
                displaySchedule();
                updateAssociateSelectors();
            }
        }

        // File Upload Handler for Excel/CSV files
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('File selected:', file.name, 'Type:', file.type, 'Size:', file.size);

            // Show loading indicator
            const fileInput = document.getElementById('fileInput');
            let loadingMsg = document.getElementById('loadingMsg');
            if (!loadingMsg) {
                loadingMsg = document.createElement('div');
                loadingMsg.id = 'loadingMsg';
                loadingMsg.style.marginTop = '10px';
                loadingMsg.style.color = 'var(--primary-color)';
                fileInput.parentNode.appendChild(loadingMsg);
            }
            loadingMsg.textContent = 'Processing file...';

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    let workbook;
                    
                    // Handle different file types
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        // For CSV files, convert to text first
                        const csvText = new TextDecoder().decode(data);
                        workbook = XLSX.read(csvText, { type: 'string' });
                    } else {
                        // For Excel files (.xlsx, .xls)
                        workbook = XLSX.read(data, { type: 'array' });
                    }
                    
                    console.log('Workbook loaded, sheets:', workbook.SheetNames);
                    
                    // Process the first sheet
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1, // Use array of arrays format
                        defval: '' // Default value for empty cells
                    });
                    
                    console.log('Sheet data:', jsonData);
                    
                    if (!jsonData || jsonData.length === 0) {
                        throw new Error('File appears to be empty or invalid');
                    }
                    
                    parseExcelScheduleData(jsonData);
                    displaySchedule();
                    updateAssociateSelectors();
                    saveDataToStorage();
                    
                    loadingMsg.textContent = `âœ… File loaded successfully! Found ${Object.keys(scheduleData).length} teams.`;
                    loadingMsg.style.color = 'var(--success-color)';
                    
                    setTimeout(() => {
                        if (loadingMsg) loadingMsg.remove();
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error processing file:', error);
                    loadingMsg.textContent = 'âŒ Error: ' + error.message;
                    loadingMsg.style.color = 'var(--danger-color)';
                    
                    setTimeout(() => {
                        if (loadingMsg) loadingMsg.remove();
                    }, 5000);
                }
            };
            
            reader.onerror = function(e) {
                console.error('FileReader error:', e);
                loadingMsg.textContent = 'âŒ Error reading file. Please try again.';
                loadingMsg.style.color = 'var(--danger-color)';
                
                setTimeout(() => {
                    if (loadingMsg) loadingMsg.remove();
                }, 5000);
            };
            
            // Read the file as array buffer for Excel files
            reader.readAsArrayBuffer(file);
        }

        // Parse Excel/CSV schedule data
        function parseExcelScheduleData(data) {
            console.log('Parsing Excel schedule data...');
            scheduleData = {};
            let currentTeam = '';
            let parsedCount = 0;
            let headerRow = -1;
            
            // Days of the week for reference
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                // Convert row to strings and clean up
                const cleanRow = row.map(cell => 
                    cell !== null && cell !== undefined ? String(cell).trim() : ''
                );
                
                // Skip empty rows
                if (cleanRow.every(cell => cell === '')) continue;
                
                // Look for team headers (rows that start with "Team")
                const firstCell = cleanRow[0].toLowerCase();
                if (firstCell.includes('team')) {
                    currentTeam = cleanRow[0];
                    scheduleData[currentTeam] = {};
                    console.log('Found team:', currentTeam);
                    continue;
                }
                
                // Look for header row (contains days of week or dates)
                if (cleanRow.some(cell => 
                    daysOfWeek.some(day => cell.toLowerCase().includes(day.toLowerCase())) ||
                    cell.match(/\d+\/\d+/) // Date format
                )) {
                    headerRow = i;
                    console.log('Found header row at:', i);
                    continue;
                }
                
                // Parse associate rows (should have name and schedule data)
                if (cleanRow[0] && cleanRow.length > 2) {
                    // Extract associate name and code
                    let associateName = cleanRow[0];
                    let associateCode = '';
                    
                    // Look for code in parentheses
                    const codeMatch = associateName.match(/\(([A-Z]{2,4})\)/);
                    if (codeMatch) {
                        associateCode = codeMatch[1];
                        associateName = associateName.replace(/\s*\([A-Z]{2,4}\)/, '').trim();
                    } else {
                        // If no code in name, look in second column
                        if (cleanRow[1] && cleanRow[1].match(/^[A-Z]{2,4}$/)) {
                            associateCode = cleanRow[1];
                        } else {
                            // Generate a code from the name
                            associateCode = associateName.substring(0, 3).toUpperCase();
                        }
                    }
                    
                    // Extract schedule (skip name and code columns)
                    const scheduleStartIndex = associateCode === cleanRow[1] ? 2 : 1;
                    const schedule = [];
                    
                    for (let j = scheduleStartIndex; j < cleanRow.length && schedule.length < 7; j++) {
                        let shift = cleanRow[j];
                        if (shift === '' || shift === null || shift === undefined) {
                            shift = 'OFF';
                        } else {
                            shift = String(shift).trim();
                            if (shift.toLowerCase() === 'off' || shift === '0' || shift === '-') {
                                shift = 'OFF';
                            }
                        }
                        schedule.push(shift);
                    }
                    
                    // Ensure we have 7 days
                    while (schedule.length < 7) {
                        schedule.push('OFF');
                    }
                    
                    // Use a default team if none is set
                    if (!currentTeam) {
                        currentTeam = 'Team General';
                        scheduleData[currentTeam] = {};
                    }
                    
                    scheduleData[currentTeam][associateName] = {
                        code: associateCode,
                        schedule: schedule
                    };
                    
                    parsedCount++;
                    console.log(`Parsed: ${associateName} (${associateCode}) - ${schedule.join(', ')}`);
                }
            }
            
            console.log(`Parsing complete. Found ${parsedCount} associates in ${Object.keys(scheduleData).length} teams.`);
            
            if (parsedCount === 0) {
                throw new Error('No valid schedule data found. Please check the file format and ensure it contains associate names and schedule data.');
            }
            
            // Clean up empty teams
            for (const teamName in scheduleData) {
                if (Object.keys(scheduleData[teamName]).length === 0) {
                    delete scheduleData[teamName];
                }
            }
        }

        // Parse schedule data from text content
        function parseScheduleData(content) {
            console.log('Parsing schedule data...');
            const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            scheduleData = {};
            let currentTeam = '';
            let parsedCount = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Skip header lines with dates
                if (line.match(/^\d+\/\d+\/\d+/)) continue;
                if (line.match(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday)/)) continue;
                if (line.toLowerCase().includes('gta north')) continue;
                
                // Look for team headers (Team XXX format)
                const teamMatch = line.match(/^Team\s+(\d+|[A-Z]+)/i);
                if (teamMatch) {
                    currentTeam = `Team ${teamMatch[1]}`;
                    scheduleData[currentTeam] = scheduleData[currentTeam] || {};
                    console.log('Found team:', currentTeam);
                    continue;
                }
                
                // Parse associate data - look for name followed by code in parentheses
                const associateMatch = line.match(/^(.+?)\s*\(([A-Z]{2,4})\)/);
                if (associateMatch && currentTeam) {
                    const name = associateMatch[1].trim();
                    const code = associateMatch[2];
                    
                    // Extract the schedule part (everything after the code)
                    const scheduleStart = line.indexOf(')') + 1;
                    const schedulePart = line.substring(scheduleStart).trim();
                    
                    if (schedulePart) {
                        const schedule = parseScheduleLine(schedulePart);
                        
                        scheduleData[currentTeam][name] = {
                            code: code,
                            schedule: schedule
                        };
                        
                        parsedCount++;
                        console.log(`Parsed: ${name} (${code}) in ${currentTeam}`);
                    }
                }
                
                // Alternative parsing for lines without clear team headers
                // Look for patterns like "John Smith (ABC) 10-9 OFF 11-5..."
                if (!currentTeam && associateMatch) {
                    // Create a default team if none specified
                    currentTeam = 'Team General';
                    scheduleData[currentTeam] = scheduleData[currentTeam] || {};
                    
                    const name = associateMatch[1].trim();
                    const code = associateMatch[2];
                    const scheduleStart = line.indexOf(')') + 1;
                    const schedulePart = line.substring(scheduleStart).trim();
                    
                    if (schedulePart) {
                        const schedule = parseScheduleLine(schedulePart);
                        
                        scheduleData[currentTeam][name] = {
                            code: code,
                            schedule: schedule
                        };
                        
                        parsedCount++;
                        console.log(`Parsed: ${name} (${code}) in ${currentTeam}`);
                    }
                }
            }
            
            console.log(`Parsing complete. Found ${parsedCount} associates in ${Object.keys(scheduleData).length} teams.`);
            
            if (parsedCount === 0) {
                throw new Error('No valid schedule data found. Please check the file format.');
            }
            
            // Clean up empty teams
            for (const teamName in scheduleData) {
                if (Object.keys(scheduleData[teamName]).length === 0) {
                    delete scheduleData[teamName];
                }
            }
        }

        function parseScheduleLine(scheduleLine) {
            // Split by various delimiters and clean up
            const shifts = scheduleLine
                .split(/[\s\t]+/)
                .filter(s => s.length > 0)
                .map(s => s.trim())
                .filter(s => s !== '');
            
            // Process each shift
            return shifts.map(shift => {
                // Handle common shift formats
                if (shift.toUpperCase() === 'OFF') return 'OFF';
                if (shift.includes('-')) return shift;
                if (shift.match(/^\d+$/)) return shift; // Just numbers
                if (shift.includes(':')) return shift; // Time with minutes
                return shift;
            });
        }

        // Generate sample data for testing
        function generateSampleData() {
            scheduleData = {
                'Team 141': {
                    'Hamil Smith': {
                        code: 'HSY',
                        schedule: ['10-9', '9:30-6', '11-5', '10-6', 'OFF', 'OFF', '10-9']
                    },
                    'Evan Godfrey': {
                        code: 'GFY',
                        schedule: ['10-9', '9:30-6', '11-5', 'OFF', 'OFF', '10-9', '10-6']
                    }
                },
                'Team 65': {
                    'Derrick Finbow': {
                        code: 'DFW',
                        schedule: ['11-9', '9:30-6', '11-5', '10-6', 'OFF', 'OFF', '11-9']
                    },
                    'Hedyeh Taghavi': {
                        code: 'HYT',
                        schedule: ['OFF', '9:30-6', '11-5', '11-9', '10-6', 'OFF', 'OFF']
                    }
                }
            };
            
            displaySchedule();
            updateAssociateSelectors();
            saveDataToStorage();
        }

        // Display schedule in grid format
        function displaySchedule() {
            const container = document.getElementById('scheduleContainer');
            if (Object.keys(scheduleData).length === 0) {
                container.innerHTML = '<div class="card"><p>No schedule data loaded. Please upload a file or generate sample data.</p></div>';
                return;
            }

            let html = '<div class="card"><div class="card-title">Current Schedule</div>';
            html += '<div class="schedule-grid">';

            for (const [teamName, associates] of Object.entries(scheduleData)) {
                html += `<div class="team-card">
                    <div class="team-header">
                        <div class="team-title">${teamName}</div>
                        <button class="btn btn-secondary" onclick="showTotalHours('${teamName}')">Total Hours</button>
                    </div>`;

                for (const [associateName, data] of Object.entries(associates)) {
                    html += `<div class="associate-schedule">
                        <div class="associate-name">${associateName} (${data.code})</div>
                        <div class="shift-times">${data.schedule.join(' | ')}</div>
                    </div>`;
                }

                html += '</div>';
            }

            html += '</div></div>';
            container.innerHTML = html;
        }

        // Show total hours calculation
        function showTotalHours(teamName) {
            const team = scheduleData[teamName];
            let html = `<div class="card"><div class="card-title">Total Hours - ${teamName}</div>`;
            html += '<div class="table-container"><table class="table"><thead><tr><th>Associate</th><th>Weekly Hours</th><th>Details</th></tr></thead><tbody>';

            for (const [associateName, data] of Object.entries(team)) {
                const totalHours = calculateWeeklyHours(data.schedule);
                const hoursBreakdown = data.schedule.map(shift => {
                    if (shift === 'OFF') return '0h';
                    return calculateShiftHours(shift) + 'h';
                }).join(', ');

                html += `<tr>
                    <td>${associateName} (${data.code})</td>
                    <td><strong>${totalHours}h</strong></td>
                    <td><small>${hoursBreakdown}</small></td>
                </tr>`;
            }

            html += '</tbody></table></div></div>';
            document.getElementById('totalHoursContainer').innerHTML = html;
        }

        function calculateWeeklyHours(schedule) {
            return schedule.reduce((total, shift) => {
                return total + calculateShiftHours(shift);
            }, 0);
        }

        function calculateShiftHours(shift) {
            if (shift === 'OFF' || !shift.includes('-')) return 0;
            
            const [start, end] = shift.split('-');
            const startHour = parseTime(start);
            const endHour = parseTime(end);
            
            let hours = endHour - startHour;
            if (hours < 0) hours += 24; // Handle overnight shifts
            return hours;
        }

        function parseTime(timeStr) {
            // Handle formats like "10", "9:30", "11"
            if (timeStr.includes(':')) {
                const [hour, minute] = timeStr.split(':');
                return parseInt(hour) + parseInt(minute) / 60;
            }
            return parseInt(timeStr);
        }

        // Modal Management
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showVacationModal() {
            updateMyRequests();
            showModal('vacationModal');
        }

        function showAdminModal() {
            showModal('adminModal');
        }

        function showEditModal() {
            showModal('editModal');
        }

        function showPrintModal() {
            updatePrintTeamSelector();
            showModal('printModal');
        }

        // Tab Management
        function switchTab(tabId, contentId) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(contentId).classList.add('active');
        }

        // Vacation Request Management
        function updateAssociateSelectors() {
            const selectors = ['vacationAssociate', 'associateTeam', 'printTeam'];
            
            // Update vacation associate selector
            const vacationSelect = document.getElementById('vacationAssociate');
            vacationSelect.innerHTML = '<option value="">Select Associate</option>';
            
            for (const [teamName, associates] of Object.entries(scheduleData)) {
                for (const associateName of Object.keys(associates)) {
                    vacationSelect.innerHTML += `<option value="${associateName}">${associateName} (${teamName})</option>`;
                }
            }
            
            // Update team selectors
            const teamSelectors = document.querySelectorAll('#associateTeam, #printTeam');
            teamSelectors.forEach(selector => {
                const currentValue = selector.value;
                selector.innerHTML = '<option value="">Select Team</option>';
                for (const teamName of Object.keys(scheduleData)) {
                    selector.innerHTML += `<option value="${teamName}">${teamName}</option>`;
                }
                selector.value = currentValue;
            });
        }

        function submitVacationRequest(event) {
            event.preventDefault();
            
            const associateName = document.getElementById('vacationAssociate').value;
            const startDate = document.getElementById('vacationStartDate').value;
            const endDate = document.getElementById('vacationEndDate').value;
            const notes = document.getElementById('vacationNotes').value;
            
            if (!associateName || !startDate || !endDate) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('End date must be after start date.');
                return;
            }
            
            const request = {
                id: Date.now(),
                associateName: associateName,
                startDate: startDate,
                endDate: endDate,
                notes: notes,
                status: 'pending',
                submittedDate: new Date().toISOString().split('T')[0],
                adminComments: ''
            };
            
            vacationRequests.push(request);
            saveDataToStorage();
            
            // Reset form
            event.target.reset();
            
            alert('Vacation request submitted successfully!');
            updateMyRequests();
        }

        function updateMyRequests() {
            const container = document.getElementById('myRequestsList');
            
            if (vacationRequests.length === 0) {
                container.innerHTML = '<p>No vacation requests found.</p>';
                return;
            }
            
            let html = '';
            vacationRequests.forEach(request => {
                html += `<div class="vacation-request ${request.status}">
                    <div class="vacation-dates">${request.startDate} to ${request.endDate}</div>
                    <div><strong>Associate:</strong> ${request.associateName}</div>
                    <div><strong>Status:</strong> <span class="vacation-status status-${request.status}">${request.status}</span></div>
                    <div><strong>Submitted:</strong> ${request.submittedDate}</div>
                    ${request.notes ? `<div><strong>Notes:</strong> ${request.notes}</div>` : ''}
                    ${request.adminComments ? `<div><strong>Admin Comments:</strong> ${request.adminComments}</div>` : ''}
                    ${request.status === 'pending' ? `<button class="btn btn-danger" onclick="cancelVacationRequest(${request.id})">Cancel Request</button>` : ''}
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function cancelVacationRequest(requestId) {
            if (confirm('Are you sure you want to cancel this vacation request?')) {
                vacationRequests = vacationRequests.filter(request => request.id !== requestId);
                saveDataToStorage();
                updateMyRequests();
                if (isAdminLoggedIn) {
                    displayAdminVacationRequests();
                }
            }
        }

        // Admin Panel Management
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                displayAdminVacationRequests();
                document.getElementById('adminPassword').value = '';
            } else {
                alert('Invalid admin password. Please try again.');
            }
        }

        function displayAdminVacationRequests() {
            const container = document.getElementById('adminVacationList');
            const filter = document.getElementById('statusFilter').value;
            
            let filteredRequests = vacationRequests;
            if (filter) {
                filteredRequests = vacationRequests.filter(request => request.status === filter);
            }
            
            if (filteredRequests.length === 0) {
                container.innerHTML = '<p>No vacation requests found.</p>';
                return;
            }
            
            let html = '';
            filteredRequests.forEach(request => {
                html += `<div class="vacation-request ${request.status}">
                    <div class="vacation-dates">${request.startDate} to ${request.endDate}</div>
                    <div><strong>Associate:</strong> ${request.associateName}</div>
                    <div><strong>Status:</strong> <span class="vacation-status status-${request.status}">${request.status}</span></div>
                    <div><strong>Submitted:</strong> ${request.submittedDate}</div>
                    ${request.notes ? `<div><strong>Notes:</strong> ${request.notes}</div>` : ''}
                    
                    <div style="margin-top: 10px;">
                        <textarea class="form-control" id="adminComment-${request.id}" placeholder="Admin comments..." style="margin-bottom: 10px;">${request.adminComments}</textarea>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="updateVacationStatus(${request.id}, 'approved')">Approve</button>
                            <button class="btn btn-danger" onclick="updateVacationStatus(${request.id}, 'rejected')">Reject</button>
                            <button class="btn btn-warning" onclick="updateVacationStatus(${request.id}, 'pending')">Set Pending</button>
                            <button class="btn btn-secondary" onclick="updateAdminComments(${request.id})">Update Comments</button>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        function filterVacationRequests() {
            displayAdminVacationRequests();
        }

        function updateVacationStatus(requestId, newStatus) {
            const request = vacationRequests.find(r => r.id === requestId);
            if (request) {
                request.status = newStatus;
                updateAdminComments(requestId);
                saveDataToStorage();
                displayAdminVacationRequests();
                alert(`Vacation request ${newStatus} successfully.`);
            }
        }

        function updateAdminComments(requestId) {
            const request = vacationRequests.find(r => r.id === requestId);
            const commentTextarea = document.getElementById(`adminComment-${requestId}`);
            if (request && commentTextarea) {
                request.adminComments = commentTextarea.value;
                saveDataToStorage();
            }
        }

        // Edit Panel Management
        function editLogin() {
            const password = document.getElementById('editPassword').value;
            if (password === EDIT_PASSWORD) {
                isEditLoggedIn = true;
                document.getElementById('editLogin').style.display = 'none';
                document.getElementById('editContent').style.display = 'block';
                updateEditPanels();
                document.getElementById('editPassword').value = '';
            } else {
                alert('Invalid edit password. Please try again.');
            }
        }

        function updateEditPanels() {
            displayTeamsList();
            displayAssociatesList();
            updateAssociateSelectors();
        }

        function addTeam() {
            const teamName = document.getElementById('newTeamName').value.trim();
            if (!teamName) {
                alert('Please enter a team name.');
                return;
            }
            
            if (scheduleData[teamName]) {
                alert('Team already exists.');
                return;
            }
            
            scheduleData[teamName] = {};
            saveDataToStorage();
            updateEditPanels();
            document.getElementById('newTeamName').value = '';
            alert('Team added successfully!');
        }

        function displayTeamsList() {
            const container = document.getElementById('teamsList');
            let html = '<h4>Existing Teams:</h4>';
            
            for (const teamName of Object.keys(scheduleData)) {
                const associateCount = Object.keys(scheduleData[teamName]).length;
                html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 5px;">
                    <span><strong>${teamName}</strong> (${associateCount} associates)</span>
                    <button class="btn btn-danger" onclick="deleteTeam('${teamName}')">Delete</button>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function deleteTeam(teamName) {
            if (confirm(`Are you sure you want to delete ${teamName} and all its associates?`)) {
                delete scheduleData[teamName];
                saveDataToStorage();
                updateEditPanels();
                displaySchedule();
            }
        }

        function addAssociate() {
            const teamName = document.getElementById('associateTeam').value;
            const associateName = document.getElementById('associateName').value.trim();
            const associateCode = document.getElementById('associateCode').value.trim().toUpperCase();
            
            if (!teamName || !associateName || !associateCode) {
                alert('Please fill in all fields.');
                return;
            }
            
            if (associateCode.length !== 3) {
                alert('Associate code must be exactly 3 characters.');
                return;
            }
            
            if (scheduleData[teamName][associateName]) {
                alert('Associate already exists in this team.');
                return;
            }
            
            scheduleData[teamName][associateName] = {
                code: associateCode,
                schedule: ['OFF', 'OFF', 'OFF', 'OFF', 'OFF', 'OFF', 'OFF'] // Default schedule
            };
            
            saveDataToStorage();
            updateEditPanels();
            displaySchedule();
            
            // Clear form
            document.getElementById('associateName').value = '';
            document.getElementById('associateCode').value = '';
            
            alert('Associate added successfully!');
        }

        function displayAssociatesList() {
            const container = document.getElementById('associatesList');
            let html = '<h4>All Associates:</h4>';
            
            for (const [teamName, associates] of Object.entries(scheduleData)) {
                if (Object.keys(associates).length > 0) {
                    html += `<div style="margin-bottom: 15px;">
                        <h5 style="color: var(--primary-color);">${teamName}</h5>`;
                    
                    for (const [associateName, data] of Object.entries(associates)) {
                        html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 3px;">
                            <span>${associateName} (${data.code})</span>
                            <button class="btn btn-danger" onclick="deleteAssociate('${teamName}', '${associateName}')">Delete</button>
                        </div>`;
                    }
                    
                    html += '</div>';
                }
            }
            
            container.innerHTML = html;
        }

        function deleteAssociate(teamName, associateName) {
            if (confirm(`Are you sure you want to delete ${associateName}?`)) {
                delete scheduleData[teamName][associateName];
                saveDataToStorage();
                updateEditPanels();
                displaySchedule();
            }
        }

        // Print Management
        function updatePrintTeamSelector() {
            const selector = document.getElementById('printTeam');
            selector.innerHTML = '<option value="">All Teams</option>';
            for (const teamName of Object.keys(scheduleData)) {
                selector.innerHTML += `<option value="${teamName}">${teamName}</option>`;
            }
        }

        function generatePrintSchedule() {
            const selectedTeam = document.getElementById('printTeam').value;
            const selectedMonth = document.getElementById('printMonth').value;
            
            if (Object.keys(scheduleData).length === 0) {
                alert('No schedule data available to print.');
                return;
            }
            
            let printData = scheduleData;
            if (selectedTeam) {
                printData = { [selectedTeam]: scheduleData[selectedTeam] };
            }
            
            let html = `<div class="print-schedule">
                <h1>GTA North Schedule - ${selectedMonth}</h1>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
                <br>`;
            
            for (const [teamName, associates] of Object.entries(printData)) {
                html += `<h2>${teamName}</h2>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Associate</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Mon</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Tue</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Wed</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Thu</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Fri</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Sat</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Sun</th>
                                <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Total Hours</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                for (const [associateName, data] of Object.entries(associates)) {
                    const totalHours = calculateWeeklyHours(data.schedule);
                    html += `<tr>
                        <td style="border: 1px solid #ccc; padding: 8px;"><strong>${associateName} (${data.code})</strong></td>`;
                    
                    // Ensure we have at least 7 days of schedule data
                    const schedule = data.schedule || [];
                    for (let i = 0; i < 7; i++) {
                        const shift = schedule[i] || 'OFF';
                        html += `<td style="border: 1px solid #ccc; padding: 8px; font-family: monospace;">${shift}</td>`;
                    }
                    
                    html += `<td style="border: 1px solid #ccc; padding: 8px;"><strong>${totalHours}h</strong></td>
                    </tr>`;
                }
                
                html += '</tbody></table>';
            }
            
            html += '</div>';
            
            // Try print window first, fallback to current window printing
            try {
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                
                if (printWindow && printWindow.document) {
                    const printContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>GTA North Schedule - ${selectedMonth}</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                h1 { color: #2563eb; }
                                h2 { color: #334155; margin-top: 30px; }
                                table { page-break-inside: avoid; }
                                @media print {
                                    body { margin: 0; }
                                    h2 { page-break-before: always; }
                                    h2:first-of-type { page-break-before: avoid; }
                                }
                            </style>
                        </head>
                        <body>
                            ${html}
                        </body>
                        </html>
                    `;
                    
                    printWindow.document.open();
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    
                    // Wait for content to load before printing
                    printWindow.onload = function() {
                        printWindow.focus();
                        setTimeout(() => {
                            printWindow.print();
                        }, 500);
                    };
                } else {
                    throw new Error('Popup blocked');
                }
            } catch (error) {
                console.log('Print window failed, using fallback method:', error);
                // Fallback: Create a temporary div in current window
                const printDiv = document.createElement('div');
                printDiv.innerHTML = html;
                printDiv.style.display = 'none';
                document.body.appendChild(printDiv);
                
                // Add print styles temporarily
                const printStyles = document.createElement('style');
                printStyles.textContent = `
                    @media print {
                        body * { visibility: hidden; }
                        .temp-print-content, .temp-print-content * { visibility: visible; }
                        .temp-print-content { position: absolute; left: 0; top: 0; width: 100%; }
                    }
                `;
                printDiv.className = 'temp-print-content';
                document.head.appendChild(printStyles);
                
                // Show print dialog
                window.print();
                
                // Clean up
                setTimeout(() => {
                    document.body.removeChild(printDiv);
                    document.head.removeChild(printStyles);
                }, 100);
            }
            
            closeModal('printModal');
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
                // Reset login states when closing modals
                if (event.target.id === 'adminModal') {
                    document.getElementById('adminLogin').style.display = 'block';
                    document.getElementById('adminContent').style.display = 'none';
                    isAdminLoggedIn = false;
                }
                if (event.target.id === 'editModal') {
                    document.getElementById('editLogin').style.display = 'block';
                    document.getElementById('editContent').style.display = 'none';
                    isEditLoggedIn = false;
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // Close any open modals
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Download Excel template
        function downloadExcelTemplate() {
            // Create sample data for the template
            const templateData = [
                ['GTA North Schedule Template'],
                [''],
                ['Team 141'],
                ['Associate Name', 'Code', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                ['Hamil Smith', 'HSY', '10-9', '9:30-6', '11-5', '10-6', 'OFF', 'OFF', '10-9'],
                ['Evan Godfrey', 'GFY', '10-9', '9:30-6', '11-5', 'OFF', 'OFF', '10-9', '10-6'],
                [''],
                ['Team 65'],
                ['Associate Name', 'Code', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                ['Derrick Finbow', 'DFW', '11-9', '9:30-6', '11-5', '10-6', 'OFF', 'OFF', '11-9'],
                ['Hedyeh Taghavi', 'HYT', 'OFF', '9:30-6', '11-5', '11-9', '10-6', 'OFF', 'OFF'],
                [''],
                ['Instructions:'],
                ['1. Each team should start with "Team [Name]" row'],
                ['2. Follow with header row: Associate Name, Code, Mon, Tue, Wed, Thu, Fri, Sat, Sun'],
                ['3. Enter associate data in subsequent rows'],
                ['4. Use time ranges like "10-9" or "9:30-6"'],
                ['5. Use "OFF" for days off'],
                ['6. Save as Excel (.xlsx) or CSV file']
            ];
            
            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Style the worksheet
            const range = XLSX.utils.decode_range(ws['!ref']);
            
            // Set column widths
            ws['!cols'] = [
                { width: 20 }, // Associate Name
                { width: 8 },  // Code
                { width: 12 }, // Monday
                { width: 12 }, // Tuesday
                { width: 12 }, // Wednesday
                { width: 12 }, // Thursday
                { width: 12 }, // Friday
                { width: 12 }, // Saturday
                { width: 12 }  // Sunday
            ];
            
            // Add the worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Schedule Template');
            
            // Generate and download the file
            const fileName = `GTA_North_Schedule_Template_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            // Show success message
            let loadingMsg = document.getElementById('loadingMsg');
            if (!loadingMsg) {
                loadingMsg = document.createElement('div');
                loadingMsg.id = 'loadingMsg';
                loadingMsg.style.marginTop = '10px';
                loadingMsg.style.color = 'var(--success-color)';
                document.getElementById('fileInput').parentNode.appendChild(loadingMsg);
            }
            loadingMsg.textContent = 'âœ… Excel template downloaded! Fill it out and upload it back.';
            
            setTimeout(() => {
                if (loadingMsg) loadingMsg.remove();
            }, 3000);
        }

        // Show file format help
        function showFileFormatHelp() {
            const helpContent = `
                <div style="line-height: 1.6;">
                    <h3>Excel/CSV File Format</h3>
                    <p>Upload an Excel (.xlsx, .xls) or CSV file with schedule data in this format:</p>
                    
                    <h4>Required Structure:</h4>
                    <div style="background: var(--bg-color); padding: 15px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; border: 1px solid var(--border-color);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="background: #f0f0f0;">
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Team 141</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Associate Name</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Code</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Mon</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Tue</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Wed</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Thu</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Fri</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Sat</strong></td>
                                <td style="border: 1px solid #ccc; padding: 4px;"><strong>Sun</strong></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ccc; padding: 4px;">Hamil Smith</td>
                                <td style="border: 1px solid #ccc; padding: 4px;">HSY</td>
                                <td style="border: 1px solid #ccc; padding: 4px;">10-9</td>
                                <td style="border: 1px solid #ccc; padding: 4px;">9:30-6</td>
                                <td style="border: 1px solid #ccc; padding: 4px;">11-5</td>
                                <td style="border: 1px solid #ccc; padding: 4px;">10-6</td>
                                <td style="border: 1px solid #ccc; padding: 4px;">OFF</td>
                                <td style="border: 1px solid #ccc; padding: 4px;">OFF</td>
                                <td style="border: 1px solid #ccc; padding: 4px;">10-9</td>
                            </tr>
                        </table>
                    </div>
                    
                    <h4>Format Rules:</h4>
                    <ul>
                        <li><strong>Team Headers:</strong> Row with "Team [Name]" in first column</li>
                        <li><strong>Column Headers:</strong> Associate Name, Code, Mon, Tue, Wed, Thu, Fri, Sat, Sun</li>
                        <li><strong>Associate Data:</strong> One row per associate with name, code, and 7 days of schedule</li>
                        <li><strong>Schedule Format:</strong> Time ranges (10-9, 9:30-6) or "OFF" for days off</li>
                        <li><strong>Codes:</strong> 2-4 letter codes (HSY, GFY, etc.)</li>
                    </ul>
                    
                    <h4>Quick Start:</h4>
                    <ol>
                        <li><strong>Download the Excel template</strong> using the button above</li>
                        <li><strong>Fill in your data</strong> following the format</li>
                        <li><strong>Save as Excel (.xlsx)</strong> or CSV file</li>
                        <li><strong>Upload the file</strong> using the file input</li>
                    </ol>
                    
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0;">
                        <strong>ðŸ’¡ Tip:</strong> The easiest way is to download our template, modify it with your data, and upload it back!
                    </div>
                </div>
            `;
            
            // Create and show help modal
            const helpModal = document.createElement('div');
            helpModal.className = 'modal active';
            helpModal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2 class="modal-title">File Format Help</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    ${helpContent}
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="downloadExcelTemplate(); this.closest('.modal').remove();">Download Template</button>
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Got it!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            
            // Close on background click
            helpModal.addEventListener('click', function(e) {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }
        setInterval(() => {
            if (Object.keys(scheduleData).length > 0 || vacationRequests.length > 0) {
                saveDataToStorage();
            }
        }, 30000); // Auto-save every 30 seconds
    </script>
</body>
</html>
